<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Web Viewer: Pink Edition (Lab 6)</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.2.1/math.js"></script>

    <style>
        /* --- ЦВЕТОВАЯ ПАЛИТРА --- */
        :root {
            --bg-main: #FFE4E1;
            --bg-frame: #FFC0CB;
            --plot-bg: #FFF0F5;
            --text-color: #4A0E2E;
            --line-color: #FF1493;
            --vertex-color: #DC143C;
            --btn-color: #FF69B4;
            --btn-hover: #FF1493;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-color);
            margin: 0;
            height: 100vh; /* На весь экран */
            overflow: hidden; /* Убираем скролл у самой страницы */
        }

        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* ЛЕВАЯ ЧАСТЬ (ГРАФИК) */
        .plot-area {
            flex: 1; /* Занимает все свободное место */
            background-color: var(--plot-bg);
            position: relative;
            min-width: 0; /* Важно для flexbox */
        }

        /* ПРАВАЯ ЧАСТЬ (ПАНЕЛЬ) */
        .control-panel {
            width: 360px; /* Фиксированная ширина */
            background-color: var(--bg-frame);
            padding: 20px;
            
            /* --- ВОТ ЭТО ДОБАВЛЯЕТ ПОЛЗУНОК СПРАВА --- */
            overflow-y: auto; 
            height: 100%; 
            box-sizing: border-box; /* Чтобы padding не ломал ширину */
            box-shadow: -4px 0 15px rgba(0,0,0,0.1);
            
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Стили скроллбара (для Chrome/Safari) */
        .control-panel::-webkit-scrollbar {
            width: 10px;
        }
        .control-panel::-webkit-scrollbar-track {
            background: #FFE4E1; 
        }
        .control-panel::-webkit-scrollbar-thumb {
            background: #FF69B4; 
            border-radius: 5px;
        }
        .control-panel::-webkit-scrollbar-thumb:hover {
            background: #FF1493; 
        }

        .control-group {
            background: rgba(255, 255, 255, 0.4);
            padding: 10px;
            border-radius: 8px;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .input-row {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        input[type="number"] {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--btn-color);
            border-radius: 4px;
            text-align: center;
        }

        button {
            width: 100%;
            padding: 10px;
            background-color: var(--btn-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
        }

        button:hover {
            background-color: var(--btn-hover);
        }

        hr {
            border: 0; height: 1px; background: var(--text-color); opacity: 0.3; margin: 10px 0;
        }

        /* --- ИСПРАВЛЕНИЕ ДЛЯ МАТРИЦЫ --- */
        textarea {
            width: 100%;
            height: 100px !important; /* Принудительная высота */
            min-height: 260px;       /* Минимальная высота */
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;        /* Можно растягивать вниз */
            border: 2px solid var(--btn-color);
            border-radius: 6px;
            background: white;
            color: black;
            padding: 10px;
            box-sizing: border-box;
            white-space: pre;        /* Сохраняет пробелы и переносы */
            overflow-x: auto;        /* Горизонтальный скролл если нужно */
        }

        h3 { margin: 0; color: var(--text-color); text-align: center; }

        /* Модальное окно */
        .modal {
            display: none; position: fixed; z-index: 9999; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.5); 
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--bg-main);
            padding: 20px;
            border: 2px solid var(--line-color);
            border-radius: 10px;
            width: 90%; height: 90%;
            display: flex; flex-direction: column;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .close-btn { width: auto; background: var(--vertex-color); padding: 5px 15px; }
        .projections-grid { display: flex; flex: 1; gap: 10px; }
        .proj-plot { flex: 1; background: #fff; border: 1px solid var(--bg-frame); }
    </style>
</head>
<body>

<div class="container">
    <!-- ГРАФИК -->
    <div id="plot3d" class="plot-area"></div>

    <!-- ПАНЕЛЬ УПРАВЛЕНИЯ (С ПОЛЗУНКОМ СПРАВА) -->
    <div class="control-panel">
        <h3>Управление (Lab 6)</h3>

        <div class="control-group">
            <label>Вращение X (°):</label>
            <div class="input-row"><input type="number" id="rotX" value="0"></div>
            <button onclick="applyRotation('x')">Применить</button>
        </div>

        <div class="control-group">
            <label>Вращение Y (°):</label>
            <div class="input-row"><input type="number" id="rotY" value="0"></div>
            <button onclick="applyRotation('y')">Применить</button>
        </div>

        <div class="control-group">
            <label>Вращение Z (°):</label>
            <div class="input-row"><input type="number" id="rotZ" value="0"></div>
            <button onclick="applyRotation('z')">Применить</button>
        </div>

        <div class="control-group">
            <label>Масштаб:</label>
            <div class="input-row"><input type="number" id="scaleVal" value="1" step="0.1"></div>
            <button onclick="applyScale()">Применить Масштаб</button>
        </div>

        <div class="control-group">
            <label>Сдвиг (X, Y, Z):</label>
            <div class="input-row">
                <input type="number" id="transX" value="0" placeholder="X">
                <input type="number" id="transY" value="0" placeholder="Y">
                <input type="number" id="transZ" value="0" placeholder="Z">
            </div>
            <button onclick="applyTranslation()">Сдвинуть</button>
        </div>

        <hr>

        <button onclick="showProjections()">ПОКАЗАТЬ ПРОЕКЦИИ (6c)</button>
        <button onclick="resetView()" style="background-color: var(--vertex-color);">Сбросить все</button>

        <hr>

        <!-- МАТРИЦА -->
        <label>Матрица преобразования:</label>
        <textarea id="matrixOutput" readonly></textarea>
        <!-- Пустой блок в конце, чтобы скролл был удобнее -->
        <div style="height: 20px;"></div>
    </div>
</div>

<!-- Модальное окно -->
<div id="projModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="color: var(--text-color); margin:0;">Ортографические проекции</h2>
            <button class="close-btn" onclick="closeProjections()">X</button>
        </div>
        <div class="projections-grid">
            <div id="projXY" class="proj-plot"></div>
            <div id="projXZ" class="proj-plot"></div>
            <div id="projYZ" class="proj-plot"></div>
        </div>
    </div>
</div>

<script>
    // --- ДАННЫЕ ---
    const initialVertices = [
        [0, 0, 1], [1, 0, 1], [1, 3, 1], [3, 3, 1], [3, 4, 1], [0, 4, 1],
        [0, 0, 0], [1, 0, 0], [1, 3, 0], [3, 3, 0], [3, 4, 0], [0, 4, 0]
    ];
    const edges = [
        [0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 0],
        [6, 7], [7, 8], [8, 9], [9, 10], [10, 11], [11, 6],
        [0, 6], [1, 7], [2, 8], [3, 9], [4, 10], [5, 11]
    ];
    
    // --- ЛОГИКА ---
    let transformationMatrix = math.identity(4);

    function getTransformedVertices() {
        let verticesHomogeneous = initialVertices.map(v => [...v, 1]);
        let matrixT = math.transpose(transformationMatrix);
        let transformed = math.multiply(verticesHomogeneous, matrixT);
        let arr = transformed.toArray();
        return arr.map(v => [v[0], v[1], v[2]]);
    }

    function applyMatrix(newMatrix) {
        transformationMatrix = math.multiply(newMatrix, transformationMatrix);
        updateView();
    }

    function applyRotation(axis) {
        let angleDeg = parseFloat(document.getElementById('rot' + axis.toUpperCase()).value);
        let angle = angleDeg * (Math.PI / 180);
        let M = math.identity(4).toArray();
        let c = Math.cos(angle), s = Math.sin(angle);

        if (axis === 'x') { M[1][1]=c; M[1][2]=-s; M[2][1]=s; M[2][2]=c; }
        else if (axis === 'y') { M[0][0]=c; M[0][2]=s; M[2][0]=-s; M[2][2]=c; }
        else { M[0][0]=c; M[0][1]=-s; M[1][0]=s; M[1][1]=c; }
        applyMatrix(M);
    }

    function applyScale() {
        let s = parseFloat(document.getElementById('scaleVal').value);
        let M = math.identity(4).toArray();
        M[0][0] = s; M[1][1] = s; M[2][2] = s;
        applyMatrix(M);
    }

    function applyTranslation() {
        let dx = parseFloat(document.getElementById('transX').value);
        let dy = parseFloat(document.getElementById('transY').value);
        let dz = parseFloat(document.getElementById('transZ').value);
        let M = math.identity(4).toArray();
        M[0][3] = dx; M[1][3] = dy; M[2][3] = dz;
        applyMatrix(M);
    }

    function resetView() {
        transformationMatrix = math.identity(4);
        document.querySelectorAll('input').forEach(i => i.value = (i.id === 'scaleVal' ? 1 : 0));
        updateView();
    }

    // --- ОТРИСОВКА ---
    function updateView() {
        let currentVertices = getTransformedVertices();
        
        // Линии
        let x=[], y=[], z=[];
        edges.forEach(e => {
            let p1 = currentVertices[e[0]], p2 = currentVertices[e[1]];
            x.push(p1[0], p2[0], null); y.push(p1[1], p2[1], null); z.push(p1[2], p2[2], null);
        });

        // Точки
        let vx = currentVertices.map(v=>v[0]), vy = currentVertices.map(v=>v[1]), vz = currentVertices.map(v=>v[2]);

        // Матрица в текст
        let mat = transformationMatrix.toArray ? transformationMatrix.toArray() : transformationMatrix;
        let matStr = mat.map(row => row.map(v => v.toFixed(2).padStart(7, ' ')).join('  ')).join('\n\n');
        document.getElementById('matrixOutput').value = matStr;

        let layout = {
            paper_bgcolor: "#FFE4E1", plot_bgcolor: "#FFE4E1",
            margin: {l:0, r:0, t:0, b:0},
            showlegend: false,
            scene: {
                aspectmode: 'data',
                xaxis: {title:'X'}, yaxis: {title:'Y'}, zaxis: {title:'Z'}
            }
        };

        Plotly.react('plot3d', [
            {type:'scatter3d', mode:'lines', x:x, y:y, z:z, line:{width:5, color:'#FF1493'}},
            {type:'scatter3d', mode:'markers', x:vx, y:vy, z:vz, marker:{size:5, color:'#DC143C'}}
        ], layout);
    }

    function showProjections() {
        document.getElementById('projModal').style.display = 'flex';
        let verts = getTransformedVertices();
        
        // Helper
        const plot2d = (div, i1, i2, title, ax1, ax2) => {
             let x=[], y=[];
             edges.forEach(e => {
                 x.push(verts[e[0]][i1], verts[e[1]][i1], null);
                 y.push(verts[e[0]][i2], verts[e[1]][i2], null);
             });
             Plotly.newPlot(div, [
                 {type:'scatter', mode:'lines', x:x, y:y, line:{color:'#FF1493'}},
                 {type:'scatter', mode:'markers', x:verts.map(v=>v[i1]), y:verts.map(v=>v[i2]), marker:{color:'#DC143C'}}
             ], {
                 title: title, margin:{l:30,r:10,t:30,b:30},
                 xaxis:{title:ax1}, yaxis:{title:ax2}
             });
        };
        
        plot2d('projXY', 0, 1, 'Oxy', 'X', 'Y');
        plot2d('projXZ', 0, 2, 'Oxz', 'X', 'Z');
        plot2d('projYZ', 1, 2, 'Oyz', 'Y', 'Z');
    }

    function closeProjections() { document.getElementById('projModal').style.display = 'none'; }

    updateView();
    window.onresize = () => Plotly.Plots.resize('plot3d');

</script>
</body>
</html>